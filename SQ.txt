CREATE OR REPLACE FUNCTION OPICSPLUS42UAT1.BC_FN_GET_SPOT_RATE(settlementDate IN VARCHAR2, spotRateValue IN NUMBER) RETURN NUMBER
IS
    spotRate   NUMBER;
    settDate   VARCHAR2(2);
    settYrMnth VARCHAR2(6);
    sqlQuery   VARCHAR2(4000);
BEGIN
    -- Enable DBMS output
    DBMS_OUTPUT.ENABLE(1000000);

    -- Extract the day and year-month from the settlement date
    settDate := TO_CHAR(TO_DATE(settlementDate, 'YYYY-MM-DD'), 'DD');
    settYrMnth := TO_CHAR(TO_DATE(settlementDate, 'YYYY-MM-DD'), 'YYYYMM');

    -- Construct the dynamic SQL query
    sqlQuery := 'UPDATE SRHR SET SPOT' || settDate || ' = :spotRateValue WHERE yearmonth = :settYrMnth';

    -- Output the SQL query for debugging purposes
    DBMS_OUTPUT.PUT_LINE(sqlQuery);

    -- Execute the dynamic SQL query
    EXECUTE IMMEDIATE sqlQuery USING spotRateValue, settYrMnth;

    -- Optionally, fetch the updated spot rate for verification
    sqlQuery := 'SELECT SPOT' || settDate || ' FROM SRHR WHERE yearmonth = :settYrMnth';
    EXECUTE IMMEDIATE sqlQuery INTO spotRate USING settYrMnth;

    -- Return the updated spot rate
    RETURN spotRate;
EXCEPTION
    WHEN OTHERS THEN
        -- Handle exceptions by raising an application error with the SQL error code and message
        RAISE_APPLICATION_ERROR(-20001, 'Error: ' || SQLCODE || ' - ' || SQLERRM);
END;
/
